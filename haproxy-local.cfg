global
    # HAProxy global configuration for SLA Monitor system (Local Installation)
    daemon
    maxconn 4096
    log stdout local0 info

    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768

    # Security (로컬 설치에서는 chroot 생략)
    user haproxy
    group haproxy

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch

    # Timeouts
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-keep-alive 4000ms
    timeout check 3000ms

    # Error pages (로컬 경로로 수정)
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Statistics page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends
    stats show-node

# Frontend - Main entry point
frontend sla_monitor_frontend
    bind *:80
    mode http

    # Security headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # CORS handling for development
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

    # Routing rules - Order matters!
    # API routes (highest priority)
    acl is_api_path path_beg /api/
    acl is_socket_io path_beg /socket.io/

    # Incident management routes
    acl is_incidents_path path_beg /incidents/

    # Health check endpoints
    acl is_health_check path /health

    # WebSocket upgrade detection
    acl is_websocket hdr(Connection) -i upgrade
    acl is_websocket hdr(Upgrade) -i websocket

    # Route to appropriate backends
    use_backend api_backend if is_api_path
    use_backend api_backend if is_socket_io
    use_backend api_backend if is_websocket
    use_backend incidents_backend if is_incidents_path
    use_backend api_backend if is_health_check

    # Default route to main application
    default_backend main_backend

# Backend - API Server (Node.js + Express)
backend api_backend
    mode http
    balance roundrobin

    # Health check
    option httpchk GET /api/health
    http-check expect status 200

    # Server configuration (로컬 호스트로 변경)
    server api1 127.0.0.1:3001 check inter 10s rise 2 fall 3 maxconn 500

    # Request/Response modifications
    http-request set-header X-Forwarded-Proto http
    http-request set-header X-Forwarded-For %[src]

    # Error handling
    errorfile 503 /usr/local/etc/haproxy/errors/api-503.http

# Backend - Main Dashboard (Next.js)
backend main_backend
    mode http
    balance roundrobin

    # Health check for Next.js app
    option httpchk GET /api/health
    http-check expect status 200

    # Server configuration (로컬 호스트로 변경)
    server main1 127.0.0.1:80 check inter 10s rise 2 fall 3 maxconn 1000

    # Next.js specific headers
    http-request set-header X-Forwarded-Proto http
    http-request set-header X-Forwarded-Host %[hdr(host)]

    # Static asset caching
    http-response set-header Cache-Control "public, max-age=31536000" if { path_beg /_next/static/ }

# Backend - Incidents Management (Next.js)
backend incidents_backend
    mode http
    balance roundrobin

    # Health check
    option httpchk GET /api/health
    http-check expect status 200

    # Server configuration (로컬 호스트로 변경)
    server incidents1 127.0.0.1:3006 check inter 10s rise 2 fall 3 maxconn 500

    # Request modifications
    http-request set-header X-Forwarded-Proto http
    http-request replace-path /incidents/(.*) /\1

    # Response modifications
    http-response replace-header Location ^http://[^/]*/(.*)$ http://%[hdr(host)]/incidents/\1

# Additional configuration for WebSocket support
backend websocket_backend
    mode http
    balance source

    # WebSocket specific timeouts
    timeout tunnel 3600s
    timeout server 3600s

    # Sticky sessions for WebSocket connections
    stick-table type ip size 100k expire 30m
    stick on src

    # WebSocket 서버 (로컬 호스트로 변경)
    server ws1 127.0.0.1:3001 check inter 10s